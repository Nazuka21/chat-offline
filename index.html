<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat + Voice + Video Call</title>
  <style>
    body { margin: 0; font-family: sans-serif; background: #f0f0f0; }
    header { background: #2196F3; color: white; padding: 10px; text-align: center; font-size: 20px; }
    main { padding: 16px; max-width: 600px; margin: auto; }
    video { width: 48%; border-radius: 8px; margin: 5px 1%; background: black; display: none; }
    .messages { background: white; min-height: 40vh; padding: 10px; border-radius: 5px; overflow-y: auto; margin-bottom: 10px; }
    .msg { margin: 5px 0; }
    .control, .chat-control, .volume-control { text-align: center; margin-top: 10px; }
    button, input[type="text"] { padding: 10px; margin: 5px; }
    .volume-control { display: flex; justify-content: center; align-items: center; gap: 10px; }
  </style>
</head>
<body>
<!-- Form Login -->
<div id="overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000000dd;color:white;z-index:9999;display:flex;flex-direction:column;justify-content:center;align-items:center;">
  <h2>Masukkan Nama dan Room</h2>
  <input type="text" id="inputName" placeholder="Nama Anda" />
  <input type="text" id="inputRoom" placeholder="Nama Room" />
  <button onclick="enterRoom()">Masuk</button>
</div>

<header id="roomTitle">Room  :    </header>
<main>
  <video id="remoteVideo" autoplay playsinline></video>
  <video id="localVideo" autoplay muted playsinline></video>

  <div class="control">
    <button onclick="startCall()">ğŸ¥ Mulai Panggilan</button>
    <button onclick="endCall()">âŒ Akhiri</button>
    <button id="recordBtn">ğŸ¤ Rekam</button>
    <button id="stopBtn" disabled>â¹ Stop</button>
  </div>

  <div class="messages" id="chatBox"></div>

  <div class="chat-control">
    <input type="text" id="chatInput" placeholder="Tulis pesan...">
    <button onclick="sendChat()">Kirim</button>
  </div>

  <div class="volume-control">
    ğŸ”Š Volume:
    <input type="range" id="volumeRange" min="0" max="1" step="0.01" value="0.1">
    <button onclick="toggleMute()" id="muteBtn">ğŸ”‡ Mute</button>
  </div>
</main>

<audio id="notifSound" src="https://www.soundjay.com/buttons/button-7.mp3" preload="auto"></audio>
<audio id="bgMusic" src="https://www.soundjay.com/free-music/cautious-path-01.mp3" preload="auto" loop autoplay></audio>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBD8-9mZJkOWrJqwyaJEgndw4_EHJ8YKxM",
    authDomain: "chatyou-89cec.firebaseapp.com",
    databaseURL: "https://chatyou-89cec-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "chatyou-89cec",
    storageBucket: "chatyou-89cec.appspot.com",
    messagingSenderId: "581474208654",
    appId: "1:581474208654:web:924db50831230ca1acf2df"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
</script>

<script>
let room = localStorage.getItem("room");
let username = localStorage.getItem("username");

function enterRoom() {
  const name = document.getElementById("inputName").value.trim();
  const roomName = document.getElementById("inputRoom").value.trim();
  if (!name || !roomName) return alert("Isi nama dan room!");
  localStorage.setItem("username", name);
  localStorage.setItem("room", roomName);
  location.reload();
}

if (!room || !username) {
  document.getElementById("overlay").style.display = "flex";
} else {
  document.getElementById("overlay").style.display = "none";
  document.getElementById("roomTitle").innerText = "Room: #" + room;
}

// Chat + Audio
const chatBox = document.getElementById("chatBox");
const notifSound = document.getElementById("notifSound");

firebase.database().ref("chat/" + room).on("child_added", snap => {
  const data = snap.val();
  const div = document.createElement("div");
  div.className = "msg";
  if (data.audio) {
    const audio = new Audio(data.audio);
    const playBtn = document.createElement("button");
    playBtn.textContent = "â–¶ï¸ Putar Suara";
    playBtn.onclick = () => audio.play();
    div.innerHTML = `<strong>${data.user}</strong><br>`;
    div.appendChild(playBtn);
  } else {
    div.innerHTML = `<strong>${data.user}</strong>: ${data.text}`;
  }
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
  if (data.user !== username) notifSound.play();
});

function sendChat() {
  const input = document.getElementById("chatInput");
  const text = input.value.trim();
  if (!text) return;
  firebase.database().ref("chat/" + room).push({ user: username, text });
  input.value = "";
}

let mediaRecorder, chunks = [];

document.getElementById("recordBtn").onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);
  chunks = [];
  mediaRecorder.ondataavailable = e => chunks.push(e.data);
  mediaRecorder.onstop = () => {
    const blob = new Blob(chunks, { type: 'audio/webm' });
    const reader = new FileReader();
    reader.onloadend = () => {
      firebase.database().ref("chat/" + room).push({
        user: username,
        audio: reader.result
      });
    };
    reader.readAsDataURL(blob);
  };
  mediaRecorder.start();
  document.getElementById("recordBtn").disabled = true;
  document.getElementById("stopBtn").disabled = false;
};

document.getElementById("stopBtn").onclick = () => {
  mediaRecorder.stop();
  document.getElementById("recordBtn").disabled = false;
  document.getElementById("stopBtn").disabled = true;
};

// Video Call sederhana
let localStream, pc = new RTCPeerConnection();
pc.ontrack = e => document.getElementById("remoteVideo").srcObject = e.streams[0];

async function startCall() {
  const local = document.getElementById("localVideo");
  const remote = document.getElementById("remoteVideo");
  local.style.display = remote.style.display = "inline-block";

  localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  local.srcObject = localStream;
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  const roomRef = firebase.database().ref("rooms/" + room);
  pc.onicecandidate = e => e.candidate && roomRef.child("candidates").push(JSON.stringify(e.candidate));

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await roomRef.child("offer").set(JSON.stringify(offer));

  roomRef.child("answer").on("value", snap => {
    if (snap.exists() && !pc.currentRemoteDescription) {
      pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(snap.val())));
    }
  });

  roomRef.child("candidates").on("child_added", snap => {
    const candidate = JSON.parse(snap.val());
    pc.addIceCandidate(new RTCIceCandidate(candidate));
  });

  roomRef.child("offer").once("value", async snap => {
    if (snap.exists()) {
      const offer = JSON.parse(snap.val());
      await pc.setRemoteDescription(new RTCSessionDescription(offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await roomRef.child("answer").set(JSON.stringify(answer));
    }
  });
}

function endCall() {
  document.getElementById("localVideo").style.display = "none";
  document.getElementById("remoteVideo").style.display = "none";
  pc.getSenders().forEach(s => pc.removeTrack(s));
  if (localStream) localStream.getTracks().forEach(track => track.stop());
}

// Volume
const bgMusic = document.getElementById("bgMusic");
bgMusic.volume = 0.1;
document.getElementById("volumeRange").oninput = e => bgMusic.volume = parseFloat(e.target.value);
function toggleMute() {
  bgMusic.muted = !bgMusic.muted;
  document.getElementById("muteBtn").textContent = bgMusic.muted ? "ğŸ”ˆ Unmute" : "ğŸ”‡ Mute";
}
</script>
</body>
</html>
