<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat + Voice + Video Call</title>
  <style>
    body { font-family: sans-serif; background: #f2f2f2; margin: 0; }
    header { background: #2196f3; color: white; padding: 10px; text-align: center; }
    #messages { height: 300px; overflow-y: auto; background: #fff; margin: 10px; padding: 10px; border-radius: 10px; box-shadow: 0 0 5px #aaa; }
    .msg { margin: 5px 0; }
    .you { text-align: right; color: green; }
    .other { text-align: left; color: black; }
    .bottom-bar { padding: 10px; background: #fff; position: sticky; bottom: 0; }
    input[type="text"] { width: 60%; padding: 8px; }
    button { padding: 8px 12px; margin: 4px; }
    audio { width: 100%; }
    #videoOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 9999;
    }
    video { width: 90vw; height: auto; max-height: 80vh; background: black; }
  </style>
</head>
<body>
<header><h2 id="roomTitle"></h2></header>
<div id="messages"></div>
<div class="bottom-bar">
  <input id="textInput" placeholder="Tulis pesan...">
  <button onclick="sendText()">Kirim</button>
  <button onclick="openVideoCall()">Video Call</button><br>
  <button id="recBtn">Rekam</button>
  <button id="stopBtn" disabled>Stop</button>
</div>

<div id="videoOverlay">
  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video>
  <button onclick="closeVideoCall()">Tutup</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBD8-9mZJkOWrJqwyaJEgndw4_EHJ8YKxM",
    authDomain: "chatyou-89cec.firebaseapp.com",
    databaseURL: "https://chatyou-89cec-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "chatyou-89cec",
    storageBucket: "chatyou-89cec.appspot.com",
    messagingSenderId: "581474208654",
    appId: "1:581474208654:web:924db50831230ca1acf2df"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let user = prompt("Nama Anda:") || "Anon";
  let room = prompt("Nama Room:") || "umum";
  document.getElementById("roomTitle").textContent = "Room: #" + room;
  const msgRef = db.ref("chat/" + room);

  msgRef.on("child_added", snap => {
    const data = snap.val();
    const div = document.createElement("div");
    div.className = "msg " + (data.user === user ? "you" : "other");
    if (data.voiceUrl) {
      div.innerHTML = `<b>${data.user}</b><br><audio controls src="${data.voiceUrl}"></audio><br><small>${data.time}</small>`;
    } else {
      div.innerHTML = `<b>${data.user}</b>: ${data.msg}<br><small>${data.time}</small>`;
    }
    document.getElementById("messages").appendChild(div);
    document.getElementById("messages").scrollTop = messages.scrollHeight;
  });

  function sendText() {
    const text = document.getElementById("textInput").value.trim();
    if (!text) return;
    msgRef.push({ user, msg: text, time: new Date().toLocaleTimeString() });
    document.getElementById("textInput").value = "";
  }

  // Voice Record
  let recorder, chunks = [];
  document.getElementById("recBtn").onclick = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recorder = new MediaRecorder(stream);
    chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      const url = URL.createObjectURL(blob);
      msgRef.push({ user, voiceUrl: url, time: new Date().toLocaleTimeString() });
    };
    recorder.start();
    recBtn.disabled = true;
    stopBtn.disabled = false;
  };
  document.getElementById("stopBtn").onclick = () => {
    recorder.stop();
    recBtn.disabled = false;
    stopBtn.disabled = true;
  };

  // Video Call P2P (sederhana)
  let pc, localStream;
  const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
  function openVideoCall() {
    document.getElementById("videoOverlay").style.display = "flex";
    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
      localStream = stream;
      document.getElementById("localVideo").srcObject = stream;
      startCall();
    });
  }
  function startCall() {
    pc = new RTCPeerConnection(servers);
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
    pc.ontrack = e => {
      document.getElementById("remoteVideo").srcObject = e.streams[0];
    };
    pc.onicecandidate = e => {
      if (e.candidate) db.ref(`call/${room}/${user}/ice`).push(e.candidate.toJSON());
    };
    db.ref(`call/${room}`).once('value').then(async snap => {
      if (!snap.hasChild('offer')) {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        db.ref(`call/${room}/offer`).set({ sdp: offer.sdp, type: offer.type });
      } else {
        db.ref(`call/${room}/offer`).on('value', async s => {
          const offer = s.val();
          await pc.setRemoteDescription(new RTCSessionDescription(offer));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          db.ref(`call/${room}/answer`).set({ sdp: answer.sdp, type: answer.type });
        });
      }
    });
    db.ref(`call/${room}/answer`).on('value', async s => {
      const answer = s.val();
      if (answer) await pc.setRemoteDescription(new RTCSessionDescription(answer));
    });
    db.ref(`call/${room}`).on('child_added', s => {
      if (s.key === 'ice') {
        Object.values(s.val()).forEach(c => pc.addIceCandidate(new RTCIceCandidate(c)));
      }
    });
  }
  function closeVideoCall() {
    document.getElementById("videoOverlay").style.display = "none";
    if (localStream) localStream.getTracks().forEach(track => track.stop());
    if (pc) pc.close();
  }
</script>
</body>
</html>
